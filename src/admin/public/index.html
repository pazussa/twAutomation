<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin Conversacional</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg:#f5f7fa; --card:#fff; --border:#e2e8f0; --accent:#2563eb; --accent-h:#1d4ed8; --danger:#dc2626; --warn:#d97706;
      --ok:#059669; --muted:#64748b; --radius:12px; --mono: ui-monospace, SFMono-Regular, Menlo, monospace;
    }
    * { box-sizing: border-box; }
    body { margin:20px; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif; background:var(--bg); color:#1f2937; }
    h1 { margin:0 0 8px; font-size:22px; }
    h2 { margin:0 0 8px; font-size:16px; }
    p.muted { color:var(--muted); margin:0 0 16px; }
    .layout { display:grid; grid-template-columns: 380px 1fr; gap:18px; align-items:start; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px 16px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    input, textarea, select { width:100%; padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:#fff; font:inherit; }
    textarea { resize:vertical; min-height:80px; }
    button { background:var(--accent); color:#fff; border:none; padding:7px 14px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
    button:hover { background:var(--accent-h); }
    button.outline { background:#fff; color:var(--accent); border:1px solid var(--accent); }
    button.outline:hover { background:var(--accent); color:#fff; }
    button.danger { background:var(--danger); }
    button.danger.outline { color:var(--danger); border-color:var(--danger); background:#fff; }
    button.danger.outline:hover { background:var(--danger); color:#fff; }
    table { width:100%; border-collapse:collapse; font-size:12.5px; }
    th, td { padding:6px 6px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top; }
    th { background:#f1f5f9; font-weight:600; position:sticky; top:0; }
    .scroll { max-height:420px; overflow-y:auto; overflow-x:scroll; }
    .tag { display:inline-flex; align-items:center; gap:4px; background:#e0f2fe; color:#0369a1; padding:3px 8px; margin:2px 6px 2px 0; border-radius:999px; font-size:11px; cursor:pointer; }
    .chips { display:flex; flex-wrap:wrap; margin:6px 0 4px; }
    .section-header { display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
    .small { font-size:11px; color:var(--muted); }
    .row-actions { display:flex; gap:4px; }
    .examples { margin-top:8px; border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff; }
    .examples h3 { margin:0 0 6px; font-size:13px; display:flex; align-items:center; justify-content:space-between; }
    .example-row { display:flex; gap:6px; margin-bottom:6px; align-items:center; }
    .example-row input[type="text"] { flex:1; font-size:12px; }
    .example-row input[type="checkbox"] { margin:0; align-self:center; }
    .divider { height:1px; background:var(--border); margin:16px 0; }
    .inline-form { display:flex; gap:6px; }
    .pill { background:#eef2ff; color:#4338ca; padding:2px 6px; border-radius:8px; font-size:11px; }
    code.inline { background:#e2e8f0; padding:2px 4px; border-radius:4px; font-family:var(--mono); font-size:12px; }
    .status { margin-top:8px; font-size:12px; }
    .warn { color:var(--warn); }
    .ok { color:var(--ok); }
    .danger-txt { color:var(--danger); }
    .flex { display:flex; gap:8px; }
    .grow { flex:1; }
    .nowrap { white-space:nowrap; }
    input[type="checkbox"] { width:auto; margin:0; cursor:pointer; }
    .checkbox-cell { width:30px; text-align:center; }
    .execute-bar { position:sticky; top:0; z-index:100; background:var(--card); padding:10px; border:1px solid var(--border); border-radius:var(--radius); margin-bottom:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .execute-bar button { background:var(--ok); }
    .execute-bar button:hover { background:#047857; }
    .execute-bar .btn-set-selector { background:#6366f1; font-size:14px; }
    .execute-bar .btn-set-selector:hover { background:#4f46e5; }
    .execute-bar button.outline { background:#fff; color:#6366f1; border-color:#6366f1; }
    .execute-bar button.outline:hover { background:#6366f1; color:#fff; }
    @media (max-width:1100px){ .layout { grid-template-columns:1fr; } }
    .intents-dropdown-panel label:hover { background: #f1f5f9 !important; }
    .intents-dropdown-panel label { transition: background 0.15s ease; }
    .intents-summary-btn:hover { background: #f9fafb !important; }
    .intents-dropdown-panel::-webkit-scrollbar { width: 6px; }
    .intents-dropdown-panel::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
    .intents-dropdown-panel::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .intents-dropdown-panel::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    input[type="checkbox"]:indeterminate { opacity: 0.6; }
    
    /* Carrusel */
    .carousel-container { margin-bottom: 20px; }
    .carousel-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 12px; }
    .carousel-nav { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 24px; cursor: pointer; transition: all 0.2s; font-weight: bold; min-width: 50px; }
    .carousel-nav:hover { background: var(--accent-h); transform: scale(1.05); }
    .carousel-nav:disabled { background: #cbd5e1; cursor: not-allowed; opacity: 0.5; }
    .carousel-indicators { display: flex; gap: 8px; flex: 1; justify-content: center; flex-wrap: wrap; }
    .indicator { background: #e2e8f0; color: #64748b; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
    .indicator:hover { background: #cbd5e1; }
    .indicator.active { background: var(--accent); color: white; }
    .carousel-wrapper { overflow: hidden; position: relative; }
    .carousel-track { display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .carousel-section { min-width: 100%; flex-shrink: 0; }
    .carousel-section .card { margin: 0; }
  </style>
</head>
<body>
  <h1>Panel de configuraci√≥n conversacional</h1>
  <p class="muted">CRUD completo de intents, ejemplos, reglas y variables. Persistencia directa en <code class="inline">tests/setup/data.ts</code>.</p>

  <!-- Carrusel de navegaci√≥n -->
  <div class="carousel-container">
    <div class="carousel-header">
      <button type="button" class="carousel-nav" id="carousel-prev">‚Äπ</button>
      <div class="carousel-indicators">
        <button type="button" class="indicator active" data-section="0">Intents</button>
        <button type="button" class="indicator" data-section="1">Reglas</button>
        <button type="button" class="indicator" data-section="2">Variables</button>
      </div>
      <button type="button" class="carousel-nav" id="carousel-next">‚Ä∫</button>
    </div>
    
    <div class="carousel-wrapper">
      <div class="carousel-track" id="carousel-track">
        <!-- Secci√≥n 0: Intents -->
        <div class="carousel-section active">
          <div class="card" id="intents-card">
        <div class="section-header" style="margin-bottom:6px;"><h2 style="margin:0">Intents</h2><div style="display:flex; gap:8px; align-items:center;">
          <button type="button" class="outline" id="btn-new-intent">Nuevo intent</button>
          <div class="small" id="stats-intents"></div></div>
        </div>
        <div class="small" style="margin-bottom:8px;">Define los comandos del usuario. Cada intent agrupa frases ejemplo que el bot debe reconocer.</div>
        <div class="execute-bar">
          <button type="button" id="btn-execute-selected">‚ñ∂ Ejecutar seleccionados</button>
          <button type="button" class="outline" id="btn-open-reports" title="Abrir carpeta de reportes">üìä Reportes</button>
          <span class="small" id="selected-count" style="margin-left:auto;">0 ejemplos seleccionados</span>
        </div>
        <div class="execute-bar" style="margin-top:6px; gap:4px;">
          <button type="button" class="outline" id="btn-select-create-set" title="Seleccionar todos los intents create*">üõ†Ô∏è Set Creaci√≥n</button>
          <button type="button" class="outline" id="btn-select-query-set" title="Seleccionar todos los intents no-create*">üîç Set Consulta</button>
          <button type="button" class="outline" id="btn-clear-selection" title="Deseleccionar todos">‚ùå Limpiar</button>
          <span class="small">Sets de prueba predefinidos</span>
        </div>
        <div id="new-intent-inline" style="display:none; margin-bottom:10px; border:1px solid var(--border); padding:10px; border-radius:10px;">
          <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Crear intent</div>
          <div class="flex" style="flex-direction:column; gap:6px;">
            <input id="new-intent-name" placeholder="nombre (sin espacios)" />
            <textarea id="new-intent-examples" placeholder="Ejemplos (uno por l√≠nea)"></textarea>
            <div class="flex" style="gap:6px;">
              <button type="button" id="confirm-create-intent">Guardar</button>
              <button type="button" class="outline" id="cancel-create-intent">Cancelar</button>
            </div>
            <div class="small">Usa las variables haciendo click en ellas en el panel lateral.</div>
            <div class="status" id="status-create-intent"></div>
          </div>
        </div>
        <div class="scroll" id="intents-list"></div>
        <div class="status" id="status-intent-gen"></div>
          </div>
        </div>
        
        <!-- Secci√≥n 1: Reglas -->
        <div class="carousel-section">
          <div class="card" id="rules-card">
        <div class="section-header" style="margin-bottom:6px;"><h2 style="margin:0">Reglas</h2><div style="display:flex; gap:8px; align-items:center;">
          <button type="button" class="outline" id="btn-new-rule">Nueva regla</button>
          <div class="small" id="stats-rules-editable"></div></div>
        </div>
        <div class="small" style="margin-bottom:8px;">Reglas con patrones simples que se pueden editar directamente. Detectan preguntas del bot y responden con variables.</div>
        <div class="scroll">
          <table id="rules-table" style="width:100%; min-width:800px;">
            <thead><tr><th style="min-width:50px">#</th><th style="min-width:150px">Frase</th><th style="min-width:80px">Acci√≥n</th><th style="min-width:100px">Reply</th><th style="min-width:120px">Nota</th><th style="min-width:150px">Intents</th><th style="min-width:120px">Acciones</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
          </div>
        </div>
        
        <!-- Reglas Solo Lectura (ocultas del carrusel pero disponibles) -->
        <div style="display:none;">
          <div class="card" id="rules-readonly-card">
        <div class="section-header" style="margin-bottom:6px;"><h2 style="margin:0">Reglas - Solo lectura</h2><div style="display:flex; gap:8px; align-items:center;">
          <div class="small" id="stats-rules-readonly"></div></div>
        </div>
        <div class="small" style="margin-bottom:8px;">Reglas con patrones regex complejos (alternativas, grupos de captura). Solo pueden editarse en <code class="inline">tests/setup/data.ts</code>.</div>
        <div class="scroll">
          <table id="rules-readonly-table" style="width:100%; min-width:800px;">
            <thead><tr><th style="min-width:50px">#</th><th style="min-width:200px">Patr√≥n</th><th style="min-width:80px">Acci√≥n</th><th style="min-width:100px">Reply</th><th style="min-width:120px">Nota</th><th style="min-width:150px">Intents</th><th style="min-width:100px">Info</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
          </div>
        </div>
        
        <!-- Secci√≥n 2: Variables -->
        <div class="carousel-section">
          <div class="card" id="side">
      <div class="section-header"><h2 style="margin:0">Variables</h2>
        <div style="display:flex; gap:6px;">
          <button type="button" class="outline" id="btn-refresh">Refrescar</button>
        </div>
      </div>
      <div class="small" style="margin-bottom:6px;">Valores din√°micos usados en intents y reglas. Click en un chip inserta en el campo activo.</div>
      <div class="chips" id="var-chips"></div>
      <div class="scroll">
        <table style="font-size:12px; margin-top:4px; width:50%; min-width:10px;" id="vars-table">
          <thead><tr><th style="width:60px; min-width:60px">Var</th><th style="width:50px; min-width:15px; max-width:50px">Valor</th><th style="width:43px; min-width:43px">Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <form id="form-new-var" class="inline-form" style="margin-top:8px;">
        <input name="name" placeholder="nuevaVar" required style="width:110px" />
        <input name="value" placeholder="valor" class="grow" />
        <button>+</button>
      </form>
      <div class="status" id="status-var"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let STATE = { intents: [], materializedIntents: [], rules: [], variables: {}, variablePools: {} };
    let currentFocusInput = null;
    document.addEventListener('focusin', e => { if (e.target.matches('input,textarea')) currentFocusInput = e.target; });

    function insertAtCursor(el, text){ if(!el) return; const start = el.selectionStart ?? el.value.length; const end = el.selectionEnd ?? start; const before = el.value.slice(0,start); const after = el.value.slice(end); el.value = before + text + after; const pos = start + text.length; el.selectionStart = el.selectionEnd = pos; el.focus(); el.dispatchEvent(new Event('input',{bubbles:true})); }

    async function fetchState(fresh=false){
      const url = '/api/state' + (fresh? '?fresh=1':'' );
      const intentsStatus = document.getElementById('status-intent-gen');
      intentsStatus.textContent = 'Cargando estado‚Ä¶';
      try {
        const r = await fetch(url, { cache:'no-store' });
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        if(!data || typeof data!== 'object') throw new Error('Respuesta inv√°lida');
        if(!Array.isArray(data.intents)) throw new Error('Sin intents');
        STATE = { 
          intents: data.intents||[], 
          materializedIntents: data.materializedIntents||[], 
          rules: data.rules||[], 
          variables: data.variables||{}, 
          variablePools: data.variablePools||{} 
        };
        console.log('[Client] Estado cargado:', {
          intents: STATE.intents.length,
          materializedIntents: STATE.materializedIntents.length,
          rules: STATE.rules.length,
          variables: Object.keys(STATE.variables).length
        });
        renderAll();
        if(!STATE.intents.length && !Object.keys(STATE.variables).length && !STATE.rules.length){
          intentsStatus.innerHTML = '<span class="warn">No se encontraron datos (intents/rules/vars vac√≠os)</span>';
        } else {
          intentsStatus.textContent = 'Datos cargados';
          setTimeout(()=>{ if(intentsStatus.textContent==='Datos cargados') intentsStatus.textContent=''; }, 2500);
        }
      } catch (err){
        console.error('Error cargando estado', err);
        intentsStatus.innerHTML = '<span class="danger-txt">Error cargando estado: '+ (err&&err.message? err.message: err)+'</span>';
      }
    }

    function renderAll(){ renderVariables(); renderIntents(); renderRules(); }

    function el(tag, attrs={}, children=[]) { 
      const n = document.createElement(tag); 
      for (const [k,v] of Object.entries(attrs)) { 
        if (k==='class') n.className=v; 
        else if (k==='html') n.innerHTML=v; 
        else if (k.startsWith('on') && typeof v==='function') n.addEventListener(k.slice(2), v); 
        else if (v !== undefined) n.setAttribute(k,v); 
      } 
      (Array.isArray(children)?children:[children]).forEach(c=>{ 
        if (c==null || c===undefined) return; 
        if (typeof c==='string') {
          n.appendChild(document.createTextNode(c));
        } else if (c instanceof Node) {
          n.appendChild(c);
        } else {
          console.error('Invalid child for appendChild:', c);
        }
      }); 
      return n; 
    }

    /************ VARIABLES ************/ 
    function renderVariables(){
      const tbody = document.querySelector('#vars-table tbody'); tbody.innerHTML='';
      const entries = Object.entries(STATE.variables).sort((a,b)=>a[0].localeCompare(b[0]));
      document.getElementById('var-chips').innerHTML = entries.map(([k])=>`<span class="tag" data-var="${k}">{${k}}</span>`).join('');
      entries.forEach(([k,v])=>{
        const tr = el('tr',{},[
          el('td',{},k),
          el('td',{},[el('input',{value:v, 'data-var-name':k, oninput:e=>e.target.dataset.dirty='1'})]),
          el('td',{},[
            el('div',{class:'row-actions'},[
              el('button',{class:'outline', onclick:()=>updateVarRow(k)},'üíæ'),
              el('button',{class:'danger outline', onclick:()=>deleteVarRow(k)},'üóëÔ∏è')
            ])
          ])
        ]);
        
        tbody.appendChild(tr);
      });
      // variable chip click
      document.querySelectorAll('[data-var]').forEach(ch=>{
        ch.addEventListener('click',()=> insertAtCursor(currentFocusInput, ch.textContent));
      });
    }
    async function updateVarRow(name){ const input = document.querySelector(`input[data-var-name="${name}"]`); if(!input) return; const r = await fetch(`/api/variables/${encodeURIComponent(name)}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({value:input.value})}); if(!r.ok){ alert('Error actualizando variable'); } fetchState(); }
    async function deleteVarRow(name){ if(!confirm(`Eliminar variable ${name}?`)) return; const r = await fetch(`/api/variables/${encodeURIComponent(name)}`, {method:'DELETE'}); if(!r.ok){ alert('Error eliminando variable'); } fetchState(); }
    document.getElementById('form-new-var').addEventListener('submit', async e=>{ e.preventDefault(); const fd = new FormData(e.target); const name=fd.get('name'); const value=fd.get('value'); const r= await fetch('/api/variables/new',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name,value})}); if(!r.ok){ const err = await r.json().catch(()=>({error:'Error'})); alert('Error creando variable: ' + err.error); return; } e.target.reset(); fetchState(); });
    document.getElementById('btn-refresh').addEventListener('click', fetchState);
    document.getElementById('btn-open-reports').addEventListener('click', async ()=>{
      try {
        const r = await fetch('/api/open-reports');
        const result = await r.json();
        if(result.ok){
          alert(`Carpeta de reportes abierta:\n${result.path}`);
        } else {
          alert('Error: ' + (result.error || 'No se pudo abrir la carpeta'));
        }
      } catch(err){
        alert('Error de red: ' + err.message);
      }
    });

    /************ INTENTS ************/ 
    function renderIntents(){
      const container = document.getElementById('intents-list'); container.innerHTML='';
      document.getElementById('stats-intents').textContent = `${STATE.intents.length} intents`;
      STATE.intents.sort((a,b)=>a.name.localeCompare(b.name)).forEach(intent=>{
        const details = el('details',{class:'intent-block', style:'border:1px solid var(--border); border-radius:10px; margin-bottom:8px; background:#fff; padding:4px 8px;'});
        const intentCheckbox = el('input',{type:'checkbox', 'data-intent-check':intent.name, onchange:(e)=>handleIntentCheckChange(e, intent.name)});
        const summary = el('summary',{style:'cursor:pointer; display:flex; align-items:center; gap:8px; list-style:none;'},[
          intentCheckbox,
          el('strong',{},intent.name),
          el('span',{class:'pill'}, `${intent.examples.length} ej.`)
        ]);
        summary.addEventListener('click', e=>{ if(e.target===intentCheckbox) e.stopPropagation(); });
        const actionsBar = el('div',{style:'display:flex; gap:6px; margin:8px 0 6px; justify-content:flex-end;'},[
          el('button',{class:'danger outline', type:'button', onclick:()=> deleteIntent(intent.name)},'Eliminar intent')
        ]);
        const examplesBox = el('div',{class:'examples', style:'margin-top:6px;'});
        intent.examples.forEach((ex,idx)=> examplesBox.appendChild(buildExampleRow(intent.name, idx, ex)) );
        const addExampleBtn = el('button',{class:'outline', type:'button', style:'margin-top:6px; width:100%;', onclick:()=> addExampleRow(intent.name, details)},'+ ejemplo');
        examplesBox.appendChild(addExampleBtn);
        details.appendChild(summary);
        details.appendChild(actionsBar);
        details.appendChild(examplesBox);
        container.appendChild(details);
      });
    }
    function buildExampleRow(intentName, idx, value){
      const checkbox = el('input',{type:'checkbox', 'data-example-check':intentName, 'data-example-idx':idx, onchange:(e)=>handleExampleCheckChange(e, intentName)});
      const inp = el('input',{type:'text', value, 'data-intent':intentName, 'data-idx':idx, onfocus:e=>currentFocusInput=e.target, style:'flex:1'});
      const saveBtn = el('button',{class:'outline', title:'Guardar', onclick:()=>saveExample(intentName, idx, inp.value)},'üíæ');
      const delBtn = el('button',{class:'danger outline', title:'Eliminar', onclick:()=>deleteExample(intentName, idx)},'üóëÔ∏è');
      return el('div',{class:'example-row'}, [checkbox, inp, el('div',{class:'row-actions'},[saveBtn, delBtn])]);
    }
    async function addExampleRow(intentName, detailsEl){
      const block = detailsEl || [...document.querySelectorAll('.intent-block')].find(b=>b.querySelector('strong')?.textContent===intentName);
      if(block && block.tagName==='DETAILS') block.open = true;
      const examplesBox = block.querySelector('.examples');
      const idx = examplesBox.querySelectorAll('.example-row').length;
      const row = buildExampleRow(intentName, idx, '');
      examplesBox.appendChild(row);
      const input = row.querySelector('input'); input.focus();
    }
    async function saveExample(intentName, idx, value){
      if(!value.trim()) { alert('El ejemplo no puede ir vac√≠o'); return; }
      // Determine if new (idx >= existing length)
      const intent = STATE.intents.find(i=>i.name===intentName);
      if (!intent) return;
      if (idx >= intent.examples.length) {
        await fetch(`/api/intents/${encodeURIComponent(intentName)}/examples`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({example:value})});
      } else {
        await fetch(`/api/intents/${encodeURIComponent(intentName)}/examples/${idx}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({example:value})});
      }
      fetchState();
    }
    async function deleteExample(intentName, idx){ if(!confirm('Eliminar ejemplo?')) return; await fetch(`/api/intents/${encodeURIComponent(intentName)}/examples/${idx}`, {method:'DELETE'}); fetchState(); }
    async function deleteIntent(intentName){ if(!confirm(`Eliminar intent "${intentName}" completo?`)) return; await fetch(`/api/intents/${encodeURIComponent(intentName)}`, {method:'DELETE'}); fetchState(); }
    document.getElementById('btn-new-intent').addEventListener('click', ()=>{
      const box = document.getElementById('new-intent-inline');
      box.style.display = box.style.display==='none' ? 'block':'none';
    });
    document.getElementById('cancel-create-intent').addEventListener('click', ()=>{
      document.getElementById('new-intent-name').value='';
      document.getElementById('new-intent-examples').value='';
      document.getElementById('new-intent-inline').style.display='none';
    });
    document.getElementById('confirm-create-intent').addEventListener('click', async ()=>{
      const name = document.getElementById('new-intent-name').value.trim();
      const examplesRaw = document.getElementById('new-intent-examples').value;
      const status = document.getElementById('status-create-intent');
      if(!name){ status.textContent='Nombre requerido'; return; }
      const examples = examplesRaw.split('\n').map(s=>s.trim()).filter(Boolean).join('\n');
      if(!examples){ status.textContent='Al menos un ejemplo'; return; }
      const r = await fetch('/api/intents',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, examples })});
      const out = await r.json();
      status.textContent = out.ok? 'Intent creado' : (out.error||'Error');
      if(out.ok){
        document.getElementById('new-intent-name').value='';
        document.getElementById('new-intent-examples').value='';
        setTimeout(()=>{ document.getElementById('new-intent-inline').style.display='none'; }, 600);
        fetchState(true);
      }
    });

    /************ RULES ************/
    // Helper para crear selector de intents como dropdown con checkboxes
    function buildIntentsSelector(selectedIntents = []) {
      const allIntents = STATE.intents.map(i => i.name).sort();
      
      // Si no hay intents seleccionados, marcar todos por defecto
      const effectiveSelection = selectedIntents.length > 0 ? selectedIntents : allIntents;
      
      // Crear contenedor principal
      const container = el('div', {
        class: 'intents-dropdown',
        style: 'position:relative; width:100%'
      });
      
      // Bot√≥n que muestra el resumen de selecci√≥n
      const summaryBtn = el('button', {
        type: 'button',
        class: 'intents-summary-btn',
        style: 'width:100%; text-align:left; padding:4px 8px; font-size:11px; background:#fff; border:1px solid var(--border); border-radius:6px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; color:#1f2937'
      });
      
      // Panel desplegable con checkboxes
      const dropdown = el('div', {
        class: 'intents-dropdown-panel',
        style: 'display:none; position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid var(--border); border-radius:6px; box-shadow:0 4px 6px rgba(0,0,0,0.1); max-height:200px; overflow-y:auto; z-index:1000; margin-top:2px'
      });
      
      // Crear checkbox "Seleccionar todos" en la parte superior
      const selectAllCheckbox = el('input', {
        type: 'checkbox',
        id: `intent-select-all-${Math.random()}`,
        checked: effectiveSelection.length === allIntents.length ? 'checked' : undefined
      });
      
      const selectAllLabel = el('label', {
        style: 'display:flex; align-items:center; gap:6px; padding:6px 8px; cursor:pointer; font-size:11px; user-select:none; font-weight:600; background:#f8fafc; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:1'
      }, [selectAllCheckbox, el('span', {}, 'Seleccionar todos')]);
      
      selectAllLabel.addEventListener('click', (e) => {
        if (e.target !== selectAllCheckbox) {
          selectAllCheckbox.checked = !selectAllCheckbox.checked;
        }
        
        // Marcar/desmarcar todos los checkboxes
        const allCheckboxes = dropdown.querySelectorAll('input[type="checkbox"][data-intent-name]');
        allCheckboxes.forEach(cb => {
          cb.checked = selectAllCheckbox.checked;
        });
        
        updateSummary();
      });
      
      dropdown.appendChild(selectAllLabel);
      
      // Crear checkboxes de intents
      allIntents.forEach(intentName => {
        const isChecked = effectiveSelection.includes(intentName);
        const checkbox = el('input', {
          type: 'checkbox',
          id: `intent-${intentName}-${Math.random()}`,
          'data-intent-name': intentName,
          checked: isChecked ? 'checked' : undefined
        });
        
        const label = el('label', {
          style: 'display:flex; align-items:center; gap:6px; padding:6px 8px; cursor:pointer; font-size:11px; user-select:none; hover:background:#f1f5f9'
        }, [checkbox, el('span', {}, intentName)]);
        
        label.addEventListener('click', (e) => {
          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
          }
          updateSummary();
        });
        
        checkbox.addEventListener('change', () => {
          updateSummary();
          updateSelectAllCheckbox();
        });
        
        dropdown.appendChild(label);
      });
      
      // Bot√≥n OK para confirmar la selecci√≥n
      const okButton = el('button', {
        type: 'button',
        style: 'width:100%; margin-top:8px; padding:6px 8px; background:var(--accent); color:white; border:none; border-radius:4px; font-size:11px; cursor:pointer; font-weight:600'
      }, 'OK - Confirmar selecci√≥n');
      
      okButton.addEventListener('click', () => {
        // Marcar como configurado expl√≠citamente
        container.dataset.configured = 'true';
        
        // Cerrar dropdown
        dropdown.style.display = 'none';
        summaryBtn.querySelector('span:last-child').textContent = '‚ñº';
        
        // Mostrar confirmaci√≥n visual temporal
        const originalBg = summaryBtn.style.background;
        summaryBtn.style.background = '#d1fae5';
        setTimeout(() => {
          summaryBtn.style.background = originalBg;
        }, 1000);
      });
      
      dropdown.appendChild(okButton);
      
      // Funci√≥n para actualizar el estado del checkbox "Seleccionar todos"
      function updateSelectAllCheckbox() {
        const intentCheckboxes = dropdown.querySelectorAll('input[type="checkbox"][data-intent-name]');
        const checkedIntents = dropdown.querySelectorAll('input[type="checkbox"][data-intent-name]:checked');
        
        if (checkedIntents.length === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else if (checkedIntents.length === intentCheckboxes.length) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = true;
        }
      }
      
      // Funci√≥n para actualizar el texto del resumen
      function updateSummary() {
        const checkedBoxes = dropdown.querySelectorAll('input[type="checkbox"][data-intent-name]:checked');
        const count = checkedBoxes.length;
        const total = allIntents.length;
        
        let text = '';
        if (count === 0) {
          // Distinguir entre "no configurado" y "expl√≠citamente vac√≠o"
          const isConfigured = container.dataset.configured === 'true';
          if (isConfigured) {
            text = '‚ùå Ning√∫n intent';
          } else {
            text = 'Seleccione intents';
          }
        } else if (count === total) {
          text = '‚úì Todos los intents';
        } else if (count === 1) {
          text = checkedBoxes[0].dataset.intentName;
        } else {
          text = `${count} intents seleccionados`;
        }
        
        summaryBtn.innerHTML = `<span>${text}</span><span>‚ñº</span>`;
      }
      
      // Toggle dropdown
      summaryBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = dropdown.style.display === 'block';
        dropdown.style.display = isVisible ? 'none' : 'block';
        summaryBtn.querySelector('span:last-child').textContent = isVisible ? '‚ñº' : '‚ñ≤';
      });
      
      // Cerrar al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          dropdown.style.display = 'none';
          summaryBtn.querySelector('span:last-child').textContent = '‚ñº';
        }
      });
      
      container.appendChild(summaryBtn);
      container.appendChild(dropdown);
      
      // Inicializar estado de configuraci√≥n
      if (selectedIntents.length > 0 && selectedIntents.length < allIntents.length) {
        // Si tiene intents espec√≠ficos seleccionados, marcar como configurado
        container.dataset.configured = 'true';
      }
      
      // Inicializar resumen
      updateSummary();
      
      return container;
    }
    
    function getSelectedIntentsFromCell(cell) {
      const container = cell.querySelector('.intents-dropdown');
      if (!container) return [];
      
      const checkboxes = container.querySelectorAll('input[type="checkbox"][data-intent-name]:checked');
      const selected = Array.from(checkboxes).map(cb => cb.dataset.intentName).filter(Boolean);
      
      const allIntents = STATE.intents.map(i => i.name);
      
      // Verificar si el usuario expl√≠citamente confirm√≥ la selecci√≥n
      const hasBeenConfigured = container.dataset.configured === 'true';
      
      // Si no ha sido configurado, devolver array vac√≠o (= todos los intents por defecto)
      if (!hasBeenConfigured) {
        return [];
      }
      
      // Si ha sido configurado y todos est√°n seleccionados, devolver array vac√≠o (= todos)
      if (selected.length === allIntents.length) {
        return [];
      }
      
      // Si ha sido configurado y ninguno est√° seleccionado, devolver el array seleccionado (que ser√° vac√≠o)
      // Esto indica expl√≠citamente "ning√∫n intent"
      return selected;
    }
    
    function deriveSimplePhrase(pattern){
      try {
        const inner = pattern.replace(/^\/(.*)\/[a-z]*$/i,'$1');
        
        // Check for substring pattern (no anchors) - used for patterns ending with ':'
        // Example: T[o√≥]t[a√°]l:
        if(!/^\^/.test(inner) && !/\$$/.test(inner)){
          let phrase = inner
            .replace(/\[a√°\]/gi,'a')
            .replace(/\[e√©\]/gi,'e')
            .replace(/\[i√≠\]/gi,'i')
            .replace(/\[o√≥\]/gi,'o')
            .replace(/\[u√∫√º\]/gi,'u')
            .replace(/\\/g,'');
          if(/[.*+?{}\[\]^$]/.test(phrase)) return null; // treat as complex if metas remain
          return phrase.trim();
        }
        
        // Accept ^(phrase)\.?$  or ^phrase\.?$
        const m = inner.match(/^\^\(?([^)$]+)\)?\\\.\?\$$/);
        if(!m) return null;
        let phrase = m[1];
        
        // Si tiene alternativas (|), tomar solo la primera opci√≥n
        if(phrase.includes('|')){
          const parts = phrase.split('|');
          phrase = parts[0].trim();
        }
        
        phrase = phrase
          .replace(/\[a√°\]/gi,'a')
          .replace(/\[e√©\]/gi,'e')
          .replace(/\[i√≠\]/gi,'i')
          .replace(/\[o√≥\]/gi,'o')
          .replace(/\[u√∫√º\]/gi,'u')
          .replace(/\\/g,'');
        if(/[.*+?{}\[\]^$]/.test(phrase)) return null; // treat as complex if metas remain
        return phrase.trim();
      } catch { return null; }
    }
    function buildPatternFromPhrase(phrase, opts){
      const esc = phrase.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      let variant = esc;
      if(opts.variants){
        variant = variant
          .replace(/a/gi,'[a√°]')
          .replace(/e/gi,'[e√©]')
          .replace(/i/gi,'[i√≠]')
          .replace(/o/gi,'[o√≥]')
          .replace(/u/gi,'[u√∫√º]');
      }
      
      // Siempre crear patr√≥n de substring match (sin anchors)
      // para que detecte la palabra/frase en cualquier parte del mensaje
      return variant;
    }
    function renderRules(){
      const tbodyEditable = document.querySelector('#rules-table tbody');
      const tbodyReadonly = document.querySelector('#rules-readonly-table tbody');
      tbodyEditable.innerHTML='';
      tbodyReadonly.innerHTML='';
      let editableCount = 0;
      let readonlyCount = 0;
      
      // Separar reglas en editables y readonly
      const editableRules = [];
      const readonlyRules = [];
      
      STATE.rules.forEach(r=>{
        const phrase = deriveSimplePhrase(r.pattern);
        if(phrase) {
          editableRules.push({...r, phrase});
        } else {
          // DESACTIVADO: reglas de solo lectura comentadas para pruebas
          // readonlyRules.push(r);
        }
      });
      
      // Agrupar editables por tipo de acci√≥n
      const groupedEditable = {
        'END_OK': [],
        'END_ERR': [],
        'REPLY': [],
        'RETRY_EXISTS': []
      };
      
      editableRules.forEach(r => {
        const actionType = r.action && r.action.type ? r.action.type : r.action;
        if (groupedEditable[actionType]) {
          groupedEditable[actionType].push(r);
        } else {
          // Si hay un tipo no esperado, a√±adirlo a un grupo gen√©rico
          if (!groupedEditable['OTHER']) groupedEditable['OTHER'] = [];
          groupedEditable['OTHER'].push(r);
        }
      });
      
      // Renderizar grupos de editables (m√°s reciente primero dentro de cada grupo)
      ['END_OK', 'END_ERR', 'REPLY', 'RETRY_EXISTS', 'OTHER'].forEach(actionType => {
        if (groupedEditable[actionType] && groupedEditable[actionType].length > 0) {
          // Ordenar por √≠ndice descendente (m√°s reciente primero)
          groupedEditable[actionType].sort((a, b) => b.idx - a.idx);
          
          groupedEditable[actionType].forEach(r => {
            editableCount++;
            tbodyEditable.appendChild(buildRuleRow(r.idx, r.phrase, r, false));
          });
        }
      });
      
      // DESACTIVADO: Renderizar readonly (m√°s reciente primero)
      // readonlyRules.sort((a, b) => b.idx - a.idx);
      // readonlyRules.forEach(r => {
      //   readonlyCount++;
      //   tbodyReadonly.appendChild(buildComplexRuleRow(r.idx, r));
      // });
      
      document.getElementById('stats-rules-editable').textContent = `${editableCount} reglas`;
      document.getElementById('stats-rules-readonly').textContent = `${readonlyCount} reglas (DESACTIVADAS)`;
    }
    function buildRuleRow(idx, phrase, rule){
      const tr = el('tr',{},[]);
      const phraseInput = el('input',{value: phrase, style:'min-width:170px'});
      const actionType = rule.action && rule.action.type ? rule.action.type : rule.action;
      const replyValue = (rule.action && rule.action.reply) ? rule.action.reply : '';
      const actionSelect = el('select',{},['END_OK','END_ERR','REPLY'].map(a=> {
        const attrs = {value: a};
        if(actionType === a) attrs.selected = 'selected';
        return el('option', attrs, a);
      }));
      const replyInput = el('input',{value: actionType==='REPLY'? replyValue:'', placeholder:'{variable}', style:'width:100px'});
      if(actionType!=='REPLY') replyInput.disabled=true;
      actionSelect.addEventListener('change', ()=>{ if(actionSelect.value==='REPLY') replyInput.disabled=false; else { replyInput.disabled=true; replyInput.value=''; } });
      const noteInput = el('input',{value: rule.note||'', placeholder:'nota'});
      
      // Crear selector de intents
      const intentsSelect = buildIntentsSelector(rule.intents || []);
      const intentsTd = el('td',{style:'min-width:150px; max-width:200px'}, intentsSelect);
      
      const saveBtn = el('button',{class:'outline', title:'Guardar', onclick:()=>{
        const newPhrase = phraseInput.value.trim(); if(!newPhrase) return alert('Frase vac√≠a');
        const pattern = buildPatternFromPhrase(newPhrase,{variants:true, punct:true});
        const selectedIntents = getSelectedIntentsFromCell(intentsTd);
        saveRule(idx, pattern, actionSelect.value, replyInput.value, noteInput.value, selectedIntents);
      }},'üíæ');
      const delBtn = el('button',{class:'danger outline', title:'Eliminar', onclick:()=>deleteRule(idx)},'üóëÔ∏è');
      tr.appendChild(el('td',{}, String(idx)));
      tr.appendChild(el('td',{}, phraseInput));
      tr.appendChild(el('td',{}, actionSelect));
      tr.appendChild(el('td',{}, replyInput));
      tr.appendChild(el('td',{}, noteInput));
      tr.appendChild(intentsTd);
      tr.appendChild(el('td',{}, el('div',{class:'row-actions'},[saveBtn, delBtn])));
      return tr;
    }
    function buildComplexRuleRow(idx, rule){
      const tr = el('tr',{},[]);
      
      // Mostrar el patr√≥n regex completo (truncado si es muy largo)
      let patternText = rule.pattern.replace(/^\/(.*)\/[a-z]*$/i,'$1');
      if(patternText.length > 100) patternText = patternText.substring(0, 97) + '...';
      const patternDisplay = el('code',{style:'font-size:11px; color:#475569; user-select:all; background:#f1f5f9; padding:4px 6px; border-radius:4px; display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap'},patternText);
      
      // Action y reply como texto (no editables)
      const actionBadge = el('span',{
        class:'pill',
        style:`background:${rule.action==='END_OK'?'#d1fae5':rule.action==='END_ERR'?'#fee2e2':'#dbeafe'}; color:${rule.action==='END_OK'?'#065f46':rule.action==='END_ERR'?'#991b1b':'#1e40af'}; font-weight:600`
      },rule.action);
      
      const replyText = rule.action==='REPLY' && rule.reply ? rule.reply : '-';
      const replySpan = el('span',{style:'font-size:12px; color:#64748b; font-family:monospace; font-weight:500'},replyText);
      
      const noteSpan = el('span',{style:'font-size:11px; color:#64748b'},rule.note||'(sin nota)');
      
      // Mostrar intents (readonly - solo informaci√≥n)
      const intentsInfo = buildIntentsDisplayReadonly(rule.intents || []);
      
      // Bot√≥n de info mejorado
      const infoBtn = el('button',{
        class:'outline',
        title:'Ver patr√≥n completo',
        style:'padding:5px 10px; font-size:12px',
        onclick:()=>{
          const intentsText = (rule.intents && rule.intents.length > 0) 
            ? rule.intents.join(', ') 
            : 'Todos los intents';
          const msg = `‚îÅ‚îÅ‚îÅ Regla #${idx} (Solo lectura) ‚îÅ‚îÅ‚îÅ\n\n` +
                      `üìã Patr√≥n completo:\n${rule.pattern}\n\n` +
                      `‚ö° Acci√≥n: ${rule.action}\n` +
                      `üí¨ Reply: ${rule.reply||'(ninguno)'}\n` +
                      `üìù Nota: ${rule.note||'(ninguna)'}\n` +
                      `üéØ Intents: ${intentsText}\n\n` +
                      `‚ÑπÔ∏è Esta regla usa expresiones regulares complejas (alternativas, grupos de captura, etc.) y solo puede editarse directamente en el archivo tests/setup/data.ts`;
          alert(msg);
        }
      },'‚ÑπÔ∏è Info');
      
      tr.appendChild(el('td',{style:'color:#64748b; font-weight:600'}, String(idx)));
      tr.appendChild(el('td',{style:'max-width:400px'}, patternDisplay));
      tr.appendChild(el('td',{}, actionBadge));
      tr.appendChild(el('td',{}, replySpan));
      tr.appendChild(el('td',{style:'max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap'}, noteSpan));
      tr.appendChild(el('td',{style:'max-width:150px'}, intentsInfo));
      tr.appendChild(el('td',{}, el('div',{class:'row-actions'},[infoBtn])));
      return tr;
    }
    
    function buildIntentsDisplayReadonly(selectedIntents = []) {
      const allIntents = STATE.intents.map(i => i.name);
      const effectiveSelection = selectedIntents.length > 0 ? selectedIntents : allIntents;
      
      if (effectiveSelection.length === allIntents.length) {
        return el('span', {style:'font-size:11px; color:var(--ok); font-weight:600; white-space:nowrap'}, '‚úì Todos');
      }
      
      const display = effectiveSelection.slice(0, 2).join(', ');
      const remaining = effectiveSelection.length - 2;
      const text = remaining > 0 ? `${display} (+${remaining})` : display;
      
      return el('span', {
        style:'font-size:11px; color:#475569; white-space:nowrap; cursor:help', 
        title: effectiveSelection.join(', ')
      }, text);
    }
    document.getElementById('btn-new-rule').addEventListener('click', ()=>{
      const tbody = document.querySelector('#rules-table tbody');
      // Evitar m√∫ltiples filas de creaci√≥n
      if(tbody.querySelector('tr[data-new="1"]')) return;
      const tr = document.createElement('tr'); tr.dataset.new='1';
      const phraseInput = el('input',{placeholder:'Frase'});
      const actionSelect = el('select',{},['END_OK','END_ERR','REPLY'].map(a=> el('option',{value:a},a)));
      const replyInput = el('input',{placeholder:'{variable}', style:'width:100px', disabled:true});
      actionSelect.addEventListener('change', ()=>{ replyInput.disabled = actionSelect.value!=='REPLY'; if(replyInput.disabled) replyInput.value=''; });
      const noteInput = el('input',{placeholder:'nota'});
      
      // Crear selector de intents (todos seleccionados por defecto)
      const intentsSelect = buildIntentsSelector([]);
      const intentsTd = el('td',{style:'min-width:150px; max-width:200px'}, intentsSelect);
      
      const saveBtn = el('button',{class:'outline', onclick:async()=>{
  const phrase = phraseInput.value.trim(); if(!phrase) return alert('Frase requerida');
  const pattern = buildPatternFromPhrase(phrase,{variants:true, punct:true});
  const selectedIntents = getSelectedIntentsFromCell(intentsTd);
  const finalIntents = selectedIntents || [];
  
  console.log('[createRule] Creando con intents:', finalIntents);
  const payload = { regex: pattern, action: actionSelect.value, reply: actionSelect.value==='REPLY'? replyInput.value: undefined, note: noteInput.value, flags:'i', priority: 1, intents: finalIntents };
  const r = await fetch('/api/rules',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if(!r.ok){ const err = await r.json().catch(()=>({error:'Error desconocido'})); alert('Error creando regla: '+(err.error||r.status)); return; }
  fetchState(true);
      }},'Guardar');
      const cancelBtn = el('button',{class:'danger outline', onclick:()=> tr.remove()},'Cancelar');
      tr.appendChild(el('td',{}, '#'));
      tr.appendChild(el('td',{}, phraseInput));
      tr.appendChild(el('td',{}, actionSelect));
      tr.appendChild(el('td',{}, replyInput));
      tr.appendChild(el('td',{}, noteInput));
      tr.appendChild(intentsTd);
      tr.appendChild(el('td',{}, el('div',{class:'row-actions'},[saveBtn, cancelBtn])));
      tbody.prepend(tr);
      phraseInput.focus();
    });
    async function saveRule(idx, regex, action, reply, note, intents){ 
      if(!regex.trim()) return alert('Patr√≥n vac√≠o');
      let actionObj;
      if(action === 'REPLY') {
        actionObj = { type: 'REPLY', reply };
      } else {
        actionObj = { type: action };
      }
      
      // intents puede ser:
      // - [] = todos los intents (cuando no se configur√≥ o cuando todos est√°n seleccionados)
      // - [intent1, intent2] = intents espec√≠ficos
      // - [] con configuraci√≥n expl√≠cita = ning√∫n intent (pero esto se maneja en el selector)
      const finalIntents = intents || [];
      
      const payload = { regex, action: actionObj, note, flags: 'i', priority: 1, intents: finalIntents };
      console.log('[saveRule] Guardando con intents:', finalIntents);
      try {
        const r = await fetch(`/api/rules/${idx}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        if(!r.ok) {
          const err = await r.json().catch(()=>({error:'Error desconocido'}));
          alert('Error actualizando regla: '+(err.error||r.status));
          return;
        }
        fetchState();
      } catch(e) {
        alert('Error de conexi√≥n al actualizar regla: ' + e.message);
      }
    }
    async function deleteRule(idx){ 
      if(!confirm('Eliminar regla?')) return; 
      try {
        const r = await fetch(`/api/rules/${idx}`, {method:'DELETE'});
        if(!r.ok) {
          const err = await r.json().catch(()=>({error:'Error desconocido'}));
          alert('Error eliminando regla: '+(err.error||r.status));
          return;
        }
        fetchState(); 
      } catch(e) {
        alert('Error de conexi√≥n al eliminar regla: ' + e.message);
      }
    }
    // (Eliminado formulario lateral de reglas; creaci√≥n inline en la tabla)

    /************ SELECTION & EXECUTION ************/
    function handleIntentCheckChange(e, intentName){
      const isChecked = e.target.checked;
      // Marcar/desmarcar todos los ejemplos de este intent
      document.querySelectorAll(`input[data-example-check="${intentName}"]`).forEach(checkbox=>{
        checkbox.checked = isChecked;
      });
      updateSelectedCount();
    }
    
    function handleExampleCheckChange(e, intentName){
      // Verificar si al menos un ejemplo del intent est√° marcado
      const allExamples = document.querySelectorAll(`input[data-example-check="${intentName}"]`);
      const checkedExamples = document.querySelectorAll(`input[data-example-check="${intentName}"]:checked`);
      const intentCheckbox = document.querySelector(`input[data-intent-check="${intentName}"]`);
      
      if(intentCheckbox){
        // Marcar el intent si al menos un ejemplo est√° seleccionado
        intentCheckbox.checked = (checkedExamples.length > 0);
        
        // Si todos los ejemplos est√°n marcados, marcar como completo
        if(allExamples.length > 0 && allExamples.length === checkedExamples.length) {
          intentCheckbox.indeterminate = false;
        } else if(checkedExamples.length > 0) {
          // Si solo algunos est√°n marcados, mostrar estado intermedio
          intentCheckbox.indeterminate = true;
        } else {
          intentCheckbox.indeterminate = false;
        }
      }
      updateSelectedCount();
    }
    
    function updateSelectedCount(){
      // Solo contar ejemplos que tienen el check marcado
      const checkedExamples = document.querySelectorAll('input[data-example-check]:checked');
      document.getElementById('selected-count').textContent = `${checkedExamples.length} ejemplos seleccionados`;
    }
    
    function getDistributedIndices(totalLength, maxToSelect) {
      if(maxToSelect >= totalLength) {
        // Si queremos seleccionar todos o m√°s, devolver todos los √≠ndices
        return Array.from({length: totalLength}, (_, i) => i);
      }
      
      const indices = [];
      
      if(maxToSelect === 1) {
        // Si solo queremos 1, tomar el del medio
        indices.push(Math.floor(totalLength / 2));
      } else if(maxToSelect === 2) {
        // Si queremos 2, tomar el primero y el √∫ltimo
        indices.push(0, totalLength - 1);
      } else {
        // Para 3 o m√°s, distribuir uniformemente
        const step = (totalLength - 1) / (maxToSelect - 1);
        for(let i = 0; i < maxToSelect; i++) {
          indices.push(Math.round(i * step));
        }
      }
      
      // Asegurar que no hay duplicados y est√°n dentro del rango
      return [...new Set(indices)].filter(i => i >= 0 && i < totalLength).slice(0, maxToSelect);
    }
    
    function selectCreateSet(){
      // Desmarcar todos primero
      clearSelection();
      
      // Definir los intents de creaci√≥n
      const createIntents = ['createChemicalProduct', 'createCrop', 'createFertilizer', 'createPlannedCampaign', 'createPlannedWork'];
      
      // Seleccionar m√°ximo 5 ejemplos distribuidos de intents de creaci√≥n
      createIntents.forEach(intentName => {
        // Seleccionar ejemplos distribuidos de este intent
        const exampleCheckboxes = document.querySelectorAll(`input[data-example-check="${intentName}"]`);
        const maxToSelect = Math.min(5, exampleCheckboxes.length);
        
        if(maxToSelect > 0) {
          // Calcular indices distribuidos
          const indices = getDistributedIndices(exampleCheckboxes.length, maxToSelect);
          
          indices.forEach(index => {
            if(exampleCheckboxes[index]) {
              exampleCheckboxes[index].checked = true;
            }
          });
        }
        
        // Actualizar el estado del checkbox del intent
        const intentCheckbox = document.querySelector(`input[data-intent-check="${intentName}"]`);
        if(intentCheckbox && maxToSelect > 0) {
          intentCheckbox.checked = true;
          // Si se seleccionaron todos los ejemplos disponibles, no mostrar estado intermedio
          if(maxToSelect === exampleCheckboxes.length) {
            intentCheckbox.indeterminate = false;
          } else {
            // Si solo se seleccionaron algunos, mostrar estado intermedio
            intentCheckbox.indeterminate = true;
          }
        }
      });
      
      updateSelectedCount();
    }
    
    function selectQuerySet(){
      // Desmarcar todos primero
      clearSelection();
      
      // Definir los intents de consulta (todos los que NO son create*)
      const queryIntents = ['assignPriceProduct', 'checkUnplannedFields', 'getActiveMattersChemicalProducts', 
                           'getChemicalProducts', 'getChemicalProductsByClient', 'getCropDistribution', 'getCrops', 
                           'getFertilizers', 'getLastPrice', 'getLastWork', 'getManufacturerProducts', 'getMinPrice', 
                           'getPendingWorks', 'getPlannedCampaignsHistory', 'getPriceVariation', 'getSeedsNeeded', 
                           'goodbye', 'greet', 'reportFinishedWork', 'requestOtp', 'searchProducts', 
                           'searchProductsCrops', 'searchProductsFertilizers', 'filterFertilizers'];
      
      // Seleccionar m√°ximo 5 ejemplos distribuidos de intents de consulta
      queryIntents.forEach(intentName => {
        // Seleccionar ejemplos distribuidos de este intent
        const exampleCheckboxes = document.querySelectorAll(`input[data-example-check="${intentName}"]`);
        const maxToSelect = Math.min(5, exampleCheckboxes.length);
        
        if(maxToSelect > 0) {
          // Calcular indices distribuidos
          const indices = getDistributedIndices(exampleCheckboxes.length, maxToSelect);
          
          indices.forEach(index => {
            if(exampleCheckboxes[index]) {
              exampleCheckboxes[index].checked = true;
            }
          });
        }
        
        // Actualizar el estado del checkbox del intent
        const intentCheckbox = document.querySelector(`input[data-intent-check="${intentName}"]`);
        if(intentCheckbox && maxToSelect > 0) {
          intentCheckbox.checked = true;
          // Si se seleccionaron todos los ejemplos disponibles, no mostrar estado intermedio
          if(maxToSelect === exampleCheckboxes.length) {
            intentCheckbox.indeterminate = false;
          } else {
            // Si solo se seleccionaron algunos, mostrar estado intermedio
            intentCheckbox.indeterminate = true;
          }
        }
      });
      
      updateSelectedCount();
    }
    
    function clearSelection(){
      // Desmarcar todos los checkboxes
      document.querySelectorAll('input[data-intent-check]').forEach(checkbox => {
        checkbox.checked = false;
        checkbox.indeterminate = false;
      });
      document.querySelectorAll('input[data-example-check]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      updateSelectedCount();
    }
    function getSelectedExamples(){
      const selected = [];
      // Solo obtener ejemplos que tienen el checkbox marcado
      document.querySelectorAll('input[data-example-check]:checked').forEach(ch=>{
        const intentName = ch.dataset.exampleCheck;
        const idx = parseInt(ch.dataset.exampleIdx);
        // Usar materializedIntents (con valores reales) si est√° disponible, sino usar intents
        const intentsSource = (STATE.materializedIntents && STATE.materializedIntents.length > 0) 
          ? STATE.materializedIntents 
          : STATE.intents;
        const intent = intentsSource.find(i=>i.name===intentName);
        if(intent && intent.examples[idx]){
          selected.push({intent: intentName, example: intent.examples[idx]});
        }
      });
      return selected;
    }
    // Verificar estado de ejecuci√≥n cada 2 segundos
    let executionCheckInterval = null;
    
    async function checkExecutionStatus() {
      try {
        const r = await fetch('/api/execution-status');
        const status = await r.json();
        const btn = document.getElementById('btn-execute-selected');
        
        if(status.isExecuting) {
          btn.disabled = true;
          btn.textContent = '‚è≥ Ejecutando... (ver terminal)';
          btn.style.opacity = '0.6';
        } else {
          btn.disabled = false;
          btn.textContent = '‚ñ∂ Ejecutar seleccionados';
          btn.style.opacity = '1';
        }
      } catch(err) {
        console.error('Error verificando estado:', err);
      }
    }
    
    // Verificar estado inicial y cada 2 segundos
    checkExecutionStatus();
    executionCheckInterval = setInterval(checkExecutionStatus, 2000);
    
    document.getElementById('btn-execute-selected').addEventListener('click', async ()=>{
      console.log('[Execution] Click en bot√≥n ejecutar');
      const selected = getSelectedExamples();
      console.log('[Execution] Ejemplos seleccionados:', selected.length, selected);
      
      if(!selected.length){ 
        alert('No hay ejemplos seleccionados'); 
        return; 
      }
      
      console.log('[Execution] Iniciando ejecuci√≥n autom√°tica...');
      console.log('[Execution] Intents:', [...new Set(selected.map(e=>e.intent))].join(', '));
      
      const btn = document.getElementById('btn-execute-selected');
      const statusEl = document.getElementById('selected-count');
      btn.disabled = true;
      btn.textContent = '‚è≥ Iniciando...';
      console.log('[Execution] Bot√≥n desactivado, enviando petici√≥n...');
      
      try {
        console.log('[Execution] Enviando POST /api/execute con', selected.length, 'ejemplos');
        const r = await fetch('/api/execute', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ examples: selected })
        });
        console.log('[Execution] Respuesta recibida:', r.status, r.statusText);
        const result = await r.json();
        console.log('[Execution] Resultado:', result);
        
        if(r.ok){
          btn.textContent = '‚è≥ Ejecutando... (ver terminal)';
          btn.style.opacity = '0.6';
          
          statusEl.innerHTML = `<span class="ok">‚úì Ejecuci√≥n en proceso: ${selected.length} ejemplos (ID: ${result.executionId})</span>`;
          
          // Mostrar notificaci√≥n
          alert(`‚úì Automatizaci√≥n de WhatsApp iniciada\n\n` +
                `Ejemplos: ${selected.length}\n` +
                `ID: ${result.executionId}\n\n` +
                `Mira la terminal del servidor para ver el progreso.\n` +
                `El bot√≥n se reactivar√° cuando termine.\n\n` +
                `Los resultados estar√°n en playwright-report/`);
          
          // Actualizar estado m√°s frecuentemente durante la ejecuci√≥n
          const fastCheck = setInterval(async () => {
            await checkExecutionStatus();
            const status = await fetch('/api/execution-status').then(r=>r.json());
            if(!status.isExecuting) {
              clearInterval(fastCheck);
              statusEl.textContent = `${selected.length} ejemplos seleccionados`;
              alert('‚úÖ Ejecuci√≥n completada!\n\nRevisa la terminal para ver los resultados.\nClick en "üìä Reportes" para abrir el reporte HTML.');
            }
          }, 1000);
          
        } else if(r.status === 409) {
          alert('‚ö†Ô∏è Ya hay una ejecuci√≥n en proceso\n\nEspera a que termine la ejecuci√≥n actual.');
          btn.disabled = false;
          btn.textContent = '‚ñ∂ Ejecutar seleccionados';
        } else {
          alert('Error al ejecutar: ' + (result.error || r.status));
          btn.disabled = false;
          btn.textContent = '‚ñ∂ Ejecutar seleccionados';
        }
      } catch(err){
        alert('Error de red: ' + err.message);
        btn.disabled = false;
        btn.textContent = '‚ñ∂ Ejecutar seleccionados';
      }
    });

    /************ CAROUSEL NAVIGATION ************/
    let currentSection = 0;
    const totalSections = 3;

    function updateCarousel() {
      const track = document.querySelector('.carousel-track');
      const indicators = document.querySelectorAll('.indicator');
      const prevBtn = document.getElementById('carousel-prev');
      const nextBtn = document.getElementById('carousel-next');
      
      if (!track) return;
      
      // Update track position
      track.style.transform = `translateX(-${currentSection * 100}%)`;
      
      // Update indicators
      indicators.forEach((ind, idx) => {
        ind.classList.toggle('active', idx === currentSection);
      });
      
      // Update navigation buttons
      prevBtn.disabled = currentSection === 0;
      nextBtn.disabled = currentSection === totalSections - 1;
    }

    function navigateCarousel(direction) {
      const newSection = currentSection + direction;
      if (newSection >= 0 && newSection < totalSections) {
        currentSection = newSection;
        updateCarousel();
      }
    }

    function goToSection(sectionIndex) {
      if (sectionIndex >= 0 && sectionIndex < totalSections) {
        currentSection = sectionIndex;
        updateCarousel();
      }
    }

    // Setup carousel after DOM is ready
    setTimeout(() => {
      const prevBtn = document.getElementById('carousel-prev');
      const nextBtn = document.getElementById('carousel-next');
      
      if (prevBtn && nextBtn) {
        prevBtn.addEventListener('click', () => navigateCarousel(-1));
        nextBtn.addEventListener('click', () => navigateCarousel(1));
        
        document.querySelectorAll('.indicator').forEach((btn, idx) => {
          btn.addEventListener('click', () => goToSection(idx));
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowLeft') {
            navigateCarousel(-1);
          } else if (e.key === 'ArrowRight') {
            navigateCarousel(1);
          }
        });
        
        updateCarousel();
        
        // Event listeners para botones de selecci√≥n de sets
        const btnSelectCreate = document.getElementById('btn-select-create-set');
        const btnSelectQuery = document.getElementById('btn-select-query-set');
        const btnClearSelection = document.getElementById('btn-clear-selection');
        
        if (btnSelectCreate) {
          btnSelectCreate.addEventListener('click', selectCreateSet);
        }
        if (btnSelectQuery) {
          btnSelectQuery.addEventListener('click', selectQuerySet);
        }
        if (btnClearSelection) {
          btnClearSelection.addEventListener('click', clearSelection);
        }
      }
    }, 100);

    /************ INIT ************/ 
  // Primera carga forzando fresh para evitar caches del navegador / proxy
  fetchState(true);
  </script>
</body>
</html>
